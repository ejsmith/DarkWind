@page "/"
@using System.Text.Json
@using DarkWind.Client.Hubs
@using XtermBlazor
@inject TelnetHub Hub

<PageTitle>Index</PageTitle>

<Xterm
    @ref="_terminal"
    Options="_options"
    OnFirstRender="@OnFirstRender"
    OnKey="@OnKey"
/>

@code {
    private Xterm _terminal;

    private TerminalOptions _options = new TerminalOptions
    {
        CursorBlink = true,
        CursorStyle = CursorStyle.Block,
        Rows = 30,
    };

    private CancellationTokenSource cts = new CancellationTokenSource();

    private async Task OnFirstRender()
    {
        await Hub.Start();

        var channel = await Hub.Connect(CancellationToken.None);
        
        await _terminal.Focus();

        while (await channel.WaitToReadAsync())
        {
            while (channel.TryRead(out var data))
            {
                await _terminal.Write(data);
            }
        }
    }

    private async Task OnKey(KeyboardEventArgs args)
    {
        var printable = (!args.AltKey && !args.CtrlKey && !args.MetaKey);
        await Hub.Send(args.Key);
        if (printable)
            await _terminal.Write(args.Key);
    }
}

